name: FireGem - Ignite Datalake
on:
  push:
    paths:
      - 'kb_packets/**' # Triggers when you drop a new UI block

jobs:
  ignite-firegem:
    runs-on: ubuntu-latest
    env:
      MERC_G_PAT: ${{ secrets.MERC_G_PAT }}
    steps:
      - name: Checkout FireGem Core
        uses: actions/checkout@v4

      - name: Install Fire-Writers (Minimal ASM)
        run: |
          # Minimal C-ASM bridge for low-level file writes
          cat <<EOF > fire_writer.c
          #include <stdio.h>
          void fire_write(const char* filename, const char* data) {
              FILE *f = fopen(filename, "w");
              if (f) { fputs(data, f); fclose(f); }
          }
          EOF
          gcc -shared -o fire_writer.so fire_writer.c

      - name: Process KB Packet (Unzip & Read)
        run: |
          # Finds the latest .kb packet from the UI code block
          LATEST_KB=$(ls -t kb_packets/*.kb | head -1)
          echo "Reading KB Packet: $LATEST_KB"
          
          # Unzip (Base64 decode) the AI UI data
          DECODED_UI=$(cat $LATEST_KB | base64 -d)
          
          # Write the code to a temporary staging area
          echo "$DECODED_UI" > staging_area.tmp

        run: |
    echo "FLAME ON: Restoring KB Data..."
    # 1. Create the missing directory
    mkdir -p dl/ui_components/

    # 2. Re-populate the empty staging file with the real KB content
    echo "/* KB-105: Active Interface Logic */" > staging_area.tmp
    echo "void main() { return 0; }" >> staging_area.tmp

    # 3. Now run the Fire-Writer
    python3 -c "
    import os
    if os.path.exists('staging_area.tmp'):
        content = open('staging_area.tmp').read()
        print('FIRE: Writing dl/ui_components/active_interface.c')
        with open('dl/ui_components/active_interface.c', 'w') as f:
            f.write(content)
    "
