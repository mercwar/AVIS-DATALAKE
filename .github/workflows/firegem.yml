# =============================================================
#  AVIS-DATALAKE: PHANTOM STRIKE (ZERO-KNOWLEDGE BOOT)
#  GOVERNANCE: AVIS_CORE | STATUS: TOTAL_AUTONOMY
# =============================================================
name: AVIS Universal Ingestion

on:
  push:
  workflow_dispatch:

jobs:
  phantom-forge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: 01_PHANTOM_CHECKOUT
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 02_INSTALL_SMITHY_TOOLS
        run: sudo apt-get update && sudo apt-get install -y nasm binutils

      - name: 03_RECURSIVE_FORGE_STRIKE
        run: |
          # Find every .asm file regardless of name or depth
          find . -name "*.asm" -not -path "*/.*" | while read -r ASM_FILE; do
            DIR=$(dirname "$ASM_FILE")
            NAME=$(basename "$ASM_FILE" .asm)
            
            echo "[AVIS-SMITHY] Forging Artifact: $NAME"
            
            # Compile to 64-bit object
            nasm -f elf64 "$ASM_FILE" -o "$DIR/$NAME.o" || echo "Skip compile: $NAME"
            
            # Attempt Static Link
            ld "$DIR/$NAME.o" -o "$DIR/$NAME.exe" 2>/dev/null || echo "Skip link: $NAME"
            
            # Attempt Shared Object Forge
            ld -shared "$DIR/$NAME.o" -o "$DIR/lib$NAME.so" 2>/dev/null || true
          done

      - name: 04_AUTOMATIC_LAKE_INGESTION
        run: |
          # Create a structured lake based solely on discovery
          mkdir -p avis-datalake/vault
          
          # Ingest every binary, object, log, and artifact found in the crawl
          # Targets: .exe, .o, .so, .log, .avis, .ini, .art
          find . -type f \( -name "*.exe" -o \
                            -name "*.o"   -o \
                            -name "*.so"  -o \
                            -name "*.log" -o \
                            -name "*.avis" -o \
                            -name "*.ini" -o \
                            -name "*.art" \) \
          -not -path "./.git/*" \
          -not -path "./avis-datalake/*" \
          -exec cp {} avis-datalake/vault/ \; 2>/dev/null || true

      - name: 05_DYNAMIC_MANIFEST_GENERATION
        run: |
          # Build the JSON map of the discovered world
          echo "[" > avis-datalake/manifest.json
          find avis-datalake/vault -type f -printf "  {\"file\": \"%f\", \"size\": \"%s\"},\n" >> avis-datalake/manifest.json 2>/dev/null || true
          # Remove trailing comma from last entry and close array
          sed -i '$ s/,$//' avis-datalake/manifest.json
          echo "]" >> avis-datalake/manifest.json

      - name: 06_REBASE_SYNC_STRIKE
        run: |
          git config --global user.name "avis-datalake-bot"
          git config --global user.email "datalake@cyborg.network"
          git add .
          if ! git diff --staged --quiet; then
            git commit -m "AVIS: Phantom Ingestion Sync [HAHA!]"
            # REBASE STRIKE: Force-sync to resolve 'cannot lock ref' glitches
            git pull --rebase -X ours origin main
            git push origin main
          else
            echo "No new data discovered."
          fi
