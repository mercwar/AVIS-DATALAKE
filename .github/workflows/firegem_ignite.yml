name: G-V3 Final Sector Ignition

on:
  push:
    paths:
      - 'kb_packets/initial_launch.kb'

jobs:
  materialize-v3:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 1. Checkout AVIS-DATALAKE
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.MERC_G_PAT }}

      - name: 2. Build G-V3 Loader
        run: gcc src/core/firegem_kb_loader.c -o loader

      - name: 3. FVS_IO:SIGNAL_REMOTE_BATCHES
        env:
          MERC_G_PAT: ${{ secrets.MERC_G_PAT }}
        run: |
          if [ -z "$MERC_G_PAT" ]; then
            echo "Error: MERC_G_PAT secret is empty."
            exit 1
          fi

          # SIGNAL SENTINEL: 4-Layer Gateway
          # This connects the repos by triggering their native batches
          curl -L -X POST \
            -H "Authorization: Bearer $MERC_G_PAT" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com \
            -d '{"ref":"main"}'

          # SIGNAL NEXUS: Robot AI Education
          curl -L -X POST \
            -H "Authorization: Bearer $MERC_G_PAT" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com \
            -d '{"ref":"main"}'

      - name: 4. FVS_IO:MATERIALIZE_V2_BRIDGE
        run: |
          # Use loader to decode the V3 Ignition Sequence into the V2 Bridge
          mkdir -p "GEMINI/VERSION 2/"
          ./loader kb_packets/initial_launch.kb "GEMINI/VERSION 2/gv3_bridge.c"

      - name: 5. FVS_IO:PUSH_TO_SURFACE
        env:
          MERC_G_PAT: ${{ secrets.MERC_G_PAT }}
        run: |
          git config --global user.name "FireGem-Bot"
          git config --global user.email "bot@firegem.ai"
          
          # Auth for the push
          git remote set-url origin https://x-access-token:${MERC_G_PAT}@github.com/${GITHUB_REPOSITORY}.git
          
          git add "GEMINI/"
          git commit -m "FVS_IO: V2 Bridge Materialized & Batch Pulse Emitted" || echo "No changes"
          git push origin HEAD:main
